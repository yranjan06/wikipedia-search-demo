<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wikipedia Search - Enhanced</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <style>
    body { background: #f6f7fb; }
    .result-snippet { color: #444; }
    .results-card .card-body { min-height: 220px; }
    .history-empty { color: #6c757d; font-style: italic; }
    .clickable { cursor: pointer; }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Search Card -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Wikipedia Search</h5>
      </div>
      <div class="card-body">
        <form id="search-form" class="row g-2">
          <div class="col-12 col-md-9">
            <label for="search-input" class="form-label visually-hidden">Search topic</label>
            <div class="input-group">
              <span class="input-group-text" id="search-addon">ðŸ”Ž</span>
              <input
                id="search-input"
                type="text"
                class="form-control"
                placeholder="Type a topic, e.g., 'JavaScript', 'Mars rover'..."
                aria-label="Search"
                aria-describedby="search-addon"
                autocomplete="off"
              />
            </div>
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button id="search-btn" type="submit" class="btn btn-primary">
              Search
            </button>
          </div>
        </form>
        <div class="form-text mt-2">
          Press Enter or click Search. Click an item in History to re-run a search.
        </div>
      </div>
    </div>

    <div class="row g-4">
      <!-- Results -->
      <div class="col-12 col-lg-8">
        <div class="card shadow-sm results-card">
          <div class="card-header bg-light">
            <strong>Results</strong>
          </div>
          <div id="results" class="card-body">
            <div class="text-center text-muted">
              Start by searching for a topic.
            </div>
          </div>
        </div>
      </div>

      <!-- History -->
      <div class="col-12 col-lg-4">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>History</strong>
            <button id="clear-history" class="btn btn-outline-secondary btn-sm" type="button" disabled>
              Clear history
            </button>
          </div>
          <div class="card-body">
            <ul id="history-list" class="list-group list-group-flush"></ul>
            <div id="history-empty" class="history-empty">No recent searches.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- History management ---
    const HISTORY_KEY = "wikiSearchHistory";
    const MAX_HISTORY = 5;

    function loadHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveHistory(history) {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, MAX_HISTORY)));
    }

    function addToHistory(topic) {
      const q = topic.trim();
      if (!q) return;
      let history = loadHistory();
      // Remove existing instance, unshift to front, cap at MAX_HISTORY
      history = [q, ...history.filter(item => item.toLowerCase() !== q.toLowerCase())].slice(0, MAX_HISTORY);
      saveHistory(history);
      renderHistory();
    }

    function clearHistory() {
      localStorage.removeItem(HISTORY_KEY);
      renderHistory();
    }

    function renderHistory() {
      const list = document.getElementById("history-list");
      const empty = document.getElementById("history-empty");
      const clearBtn = document.getElementById("clear-history");
      list.innerHTML = "";
      const history = loadHistory();

      if (!history.length) {
        empty.style.display = "block";
        clearBtn.disabled = true;
        return;
      }

      empty.style.display = "none";
      clearBtn.disabled = false;

      history.forEach(topic => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center clickable";
        li.title = `Search for "${topic}"`;
        li.innerHTML = `
          <span class="text-truncate" style="max-width: 75%">${topic}</span>
          <span class="badge text-bg-light">Search</span>
        `;
        li.addEventListener("click", () => {
          document.getElementById("search-input").value = topic;
          handleSearch(topic);
        });
        list.appendChild(li);
      });
    }

    // --- Search logic ---
    const resultsEl = document.getElementById("results");
    const formEl = document.getElementById("search-form");
    const inputEl = document.getElementById("search-input");
    const clearBtn = document.getElementById("clear-history");

    function setLoading(isLoading) {
      if (isLoading) {
        resultsEl.innerHTML = `
          <div class="d-flex align-items-center justify-content-center my-4">
            <div class="spinner-border text-primary me-2" role="status" aria-hidden="true"></div>
            <span>Searching Wikipedia...</span>
          </div>
        `;
      }
    }

    async function searchWikipedia(query) {
      const endpoint = "https://en.wikipedia.org/w/api.php";
      const params = new URLSearchParams({
        action: "query",
        list: "search",
        srsearch: query,
        format: "json",
        origin: "*",
        srlimit: "20"
      });

      const url = `${endpoint}?${params.toString()}`;
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(`Request failed: ${res.status}`);
      }
      return res.json();
    }

    function renderResults(items, query) {
      if (!items.length) {
        resultsEl.innerHTML = `
          <div class="alert alert-warning mb-0">
            No results found for "<strong>${escapeHtml(query)}</strong>".
          </div>
        `;
        return;
      }

      const fragment = document.createDocumentFragment();
      items.forEach(item => {
        const card = document.createElement("div");
        card.className = "card mb-3";

        const title = item.title;
        const pageUrl = `https://en.wikipedia.org/?curid=${item.pageid}`;
        const snippet = item.snippet; // already HTML with <span class="searchmatch">

        card.innerHTML = `
          <div class="card-body">
            <h5 class="card-title mb-1">
              <a href="${pageUrl}" target="_blank" rel="noopener noreferrer">${escapeHtml(title)}</a>
            </h5>
            <p class="card-text result-snippet mb-2">${snippet}...</p>
            <a class="btn btn-sm btn-outline-primary" href="${pageUrl}" target="_blank" rel="noopener noreferrer">Open article</a>
          </div>
        `;
        fragment.appendChild(card);
      });

      resultsEl.innerHTML = "";
      resultsEl.appendChild(fragment);
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function handleSearch(rawQuery) {
      const query = (rawQuery ?? inputEl.value).trim();
      if (!query) {
        resultsEl.innerHTML = `
          <div class="alert alert-info mb-0">Please enter a topic to search.</div>
        `;
        return;
      }

      // Record the search
      addToHistory(query);

      // Perform the search
      setLoading(true);
      try {
        const data = await searchWikipedia(query);
        const items = data?.query?.search ?? [];
        renderResults(items, query);
      } catch (err) {
        resultsEl.innerHTML = `
          <div class="alert alert-danger mb-0">
            Something went wrong. Please try again later.
          </div>
        `;
        console.error(err);
      }
    }

    // --- Events ---
    formEl.addEventListener("submit", (e) => {
      e.preventDefault();
      handleSearch();
    });

    clearBtn.addEventListener("click", () => {
      clearHistory();
      inputEl.focus();
    });

    // Initial render
    renderHistory();
  </script>
</body>
</html>